<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth & Database Test</title>
    <link rel="stylesheet" href="../css/scrollbar.css">
    <script src="../js/env.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        button {
            background: #4285F4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #357ae8;
        }
        textarea {
            width: 100%;
            height: 200px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
        }
        .info {
            background: #cce5ff;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>OAuth & Database Configuration Test</h1>
    
    <div class="info">
        <strong>Testing Environment:</strong> <span id="currentOrigin"></span><br>
        <strong>Current Time:</strong> <span id="currentTime"></span>
    </div>

    <div class="test-container">
        <h2>1. Configuration Check</h2>
        <div id="configStatus"></div>
        <button onclick="checkConfiguration()">Check Configuration</button>
    </div>

    <div class="test-container">
        <h2>2. Apps Script API Test</h2>
        <div id="apiStatus"></div>
        <button onclick="testAppsScript()">Test Apps Script</button>
        <button onclick="testDatabaseSave()">Test Database Save</button>
    </div>

    <div class="test-container">
        <h2>3. Google OAuth Test</h2>
        <div id="oauthStatus"></div>
        <div id="g_id_onload"
             data-client_id="932373464615-f07kgcbiulom1g59nrs5i6k696m5lq3t.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleOAuthTest"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-shape="rectangular"
             data-theme="filled_blue"
             data-text="signin_with"
             data-size="large">
        </div>
    </div>

    <div class="test-container">
        <h2>4. Network & CORS Test</h2>
        <div id="corsStatus"></div>
        <button onclick="testCORS()">Test CORS</button>
    </div>

    <div class="test-container">
        <h2>5. Debug Log</h2>
        <textarea id="debugLog" readonly placeholder="Debug information will appear here..."></textarea>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="downloadLog()">Download Log</button>
    </div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
    const GOOGLE_CLIENT_ID = (window.__ENV__ && window.__ENV__.GOOGLE_CLIENT_ID) ? window.__ENV__.GOOGLE_CLIENT_ID : '932373464615-f07kgcbiulom1g59nrs5i6k696m5lq3t.apps.googleusercontent.com';
    const APPS_SCRIPT_URL = (window.__ENV__ && window.__ENV__.APPS_SCRIPT_URL) ? window.__ENV__.APPS_SCRIPT_URL : 'https://script.google.com/macros/s/AKfycbxpH3tbEZ_C9jWvXZQhefCIhCps1aKZm01TQURPxyvCbIKb0Jw6yyMuoUyWzCARZVMs-w/exec';

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            const debugLog = document.getElementById('debugLog');
            debugLog.value += logEntry;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(logEntry);
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }

        function checkConfiguration() {
            log('Checking configuration...');
            
            let issues = [];
            let success = [];

            // Check Google Client ID
            if (GOOGLE_CLIENT_ID && GOOGLE_CLIENT_ID !== 'YOUR_GOOGLE_CLIENT_ID_HERE') {
                success.push('‚úÖ Google Client ID is configured');
                log('Google Client ID: Configured');
            } else {
                issues.push('‚ùå Google Client ID not configured');
                log('Google Client ID: NOT CONFIGURED', 'error');
            }

            // Check Apps Script URL
            if (APPS_SCRIPT_URL && APPS_SCRIPT_URL !== 'YOUR_APPS_SCRIPT_URL_HERE') {
                success.push('‚úÖ Apps Script URL is configured');
                log('Apps Script URL: Configured');
            } else {
                issues.push('‚ùå Apps Script URL not configured');
                log('Apps Script URL: NOT CONFIGURED', 'error');
            }

            // Check current origin
            const origin = window.location.origin;
            success.push(`üìç Current origin: ${origin}`);
            log(`Current origin: ${origin}`);

            // Check Google API availability
            if (window.google) {
                success.push('‚úÖ Google API library loaded');
                log('Google API: Loaded');
            } else {
                issues.push('‚ùå Google API library not loaded');
                log('Google API: NOT LOADED', 'error');
            }

            const statusHtml = [
                ...success.map(item => `<div class="success">${item}</div>`),
                ...issues.map(item => `<div class="error">${item}</div>`)
            ].join('');

            showStatus('configStatus', statusHtml, '');
        }

        async function testAppsScript() {
            log('Testing Apps Script endpoint...');
            
            try {
                showStatus('apiStatus', '<div class="warning">‚è≥ Testing Apps Script connection...</div>', '');
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'GET',
                    mode: 'cors'
                });

                log(`Apps Script response status: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.text();
                    log(`Apps Script response: ${result}`);
                    showStatus('apiStatus', '<div class="success">‚úÖ Apps Script endpoint is reachable</div>', '');
                } else {
                    log(`Apps Script error: ${response.statusText}`, 'error');
                    showStatus('apiStatus', `<div class="error">‚ùå Apps Script returned error: ${response.status} ${response.statusText}</div>`, '');
                }
            } catch (error) {
                log(`Apps Script connection failed: ${error.message}`, 'error');
                showStatus('apiStatus', `<div class="error">‚ùå Failed to connect to Apps Script: ${error.message}</div>`, '');
            }
        }

        async function testDatabaseSave() {
            log('Testing database save functionality...');
            
            const testData = {
                action: 'saveUser',
                email: 'test@mhs.itenas.ac.id',
                name: 'Test User',
                picture: '',
                loginTime: new Date().toISOString()
            };

            try {
                showStatus('apiStatus', '<div class="warning">‚è≥ Testing database save...</div>', '');
                
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData),
                    mode: 'cors'
                });

                log(`Database save response status: ${response.status}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log(`Database save result: ${JSON.stringify(result)}`);
                    
                    if (result.success) {
                        showStatus('apiStatus', '<div class="success">‚úÖ Database save test successful</div>', '');
                    } else {
                        showStatus('apiStatus', `<div class="error">‚ùå Database save failed: ${result.message}</div>`, '');
                    }
                } else {
                    const errorText = await response.text();
                    log(`Database save error: ${errorText}`, 'error');
                    showStatus('apiStatus', `<div class="error">‚ùå Database save error: ${response.status}</div>`, '');
                }
            } catch (error) {
                log(`Database save failed: ${error.message}`, 'error');
                showStatus('apiStatus', `<div class="error">‚ùå Database save failed: ${error.message}</div>`, '');
            }
        }

        function handleOAuthTest(response) {
            log('OAuth test response received');
            
            try {
                const userInfo = parseJwt(response.credential);
                log(`OAuth user info: ${JSON.stringify(userInfo)}`);
                
                if (userInfo && userInfo.email) {
                    if (userInfo.email.endsWith('@mhs.itenas.ac.id')) {
                        showStatus('oauthStatus', `<div class="success">‚úÖ OAuth test successful for: ${userInfo.email}</div>`, '');
                        log(`OAuth test successful for: ${userInfo.email}`);
                    } else {
                        showStatus('oauthStatus', `<div class="warning">‚ö†Ô∏è OAuth works but wrong domain: ${userInfo.email}</div>`, '');
                        log(`OAuth works but wrong domain: ${userInfo.email}`, 'warning');
                    }
                } else {
                    showStatus('oauthStatus', '<div class="error">‚ùå OAuth test failed - no email received</div>', '');
                    log('OAuth test failed - no email received', 'error');
                }
            } catch (error) {
                log(`OAuth test error: ${error.message}`, 'error');
                showStatus('oauthStatus', `<div class="error">‚ùå OAuth test error: ${error.message}</div>`, '');
            }
        }

        async function testCORS() {
            log('Testing CORS configuration...');
            
            try {
                showStatus('corsStatus', '<div class="warning">‚è≥ Testing CORS...</div>', '');
                
                // Test OPTIONS request
                const optionsResponse = await fetch(APPS_SCRIPT_URL, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });

                log(`CORS OPTIONS response: ${optionsResponse.status}`);
                
                // Test POST request
                const postResponse = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    },
                    body: JSON.stringify({ action: 'test' }),
                    mode: 'cors'
                });

                log(`CORS POST response: ${postResponse.status}`);
                
                if (postResponse.ok) {
                    showStatus('corsStatus', '<div class="success">‚úÖ CORS is properly configured</div>', '');
                    log('CORS test successful');
                } else {
                    showStatus('corsStatus', `<div class="error">‚ùå CORS test failed: ${postResponse.status}</div>`, '');
                    log(`CORS test failed: ${postResponse.status}`, 'error');
                }
                
            } catch (error) {
                log(`CORS test error: ${error.message}`, 'error');
                showStatus('corsStatus', `<div class="error">‚ùå CORS error: ${error.message}</div>`, '');
            }
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                log(`JWT parsing error: ${error.message}`, 'error');
                return null;
            }
        }

        function clearLog() {
            document.getElementById('debugLog').value = '';
            log('Debug log cleared');
        }

        function downloadLog() {
            const log = document.getElementById('debugLog').value;
            const blob = new Blob([log], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oauth-debug-${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentOrigin').textContent = window.location.origin;
            document.getElementById('currentTime').textContent = new Date().toISOString();
            
            log('OAuth & Database Test page loaded');
            log(`Origin: ${window.location.origin}`);
            log(`User Agent: ${navigator.userAgent}`);
            
            // Auto-run configuration check
            setTimeout(checkConfiguration, 1000);
        });

        // Listen for Google API load
        window.addEventListener('load', function() {
            if (window.google) {
                log('Google API loaded successfully');
                google.accounts.id.initialize({
                    client_id: GOOGLE_CLIENT_ID,
                    callback: handleOAuthTest
                });
            } else {
                log('Google API failed to load', 'error');
            }
        });
    </script>
</body>
</html>
